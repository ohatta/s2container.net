<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- don't edit start -->
<head><title>Seasar - DI Container with AOP - </title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link href="seasar_b.css" type="text/css" rel="stylesheet" media="screen">
<link rel="stylesheet" type="text/css" href="csharp.css" >
<link href="seasar_p.css" type="text/css" rel="stylesheet" media="print"><script src="seasar_b.js" type="text/JavaScript" language="JavaScript"></script>
</head><body onload="preload('ja')"><table width="100%" border="0" cellspacing="0" cellpadding="0" align="left"><tr>
<td align="left" valign="top" width="780"><table width="780" border="0" cellspacing="0" cellpadding="0" class="white">
<tr><td colspan="7"><img height="5" width="780" src="images/top01_b.gif" alt=""></td></tr>
<tr><td><img height="117" width="235" src="images/top02_b.gif" alt="Seasar"></td>
<td colspan="3"><img height="117" width="289" src="images/top03.gif" alt="DI Container with AOP"></td>
<td colspan="3"><img height="117" width="256" src="images/spacer.gif" alt=""></td>
</tr><tr><td rowspan="2"><img src="images/top04.gif" alt="" height="49" width="235"></td>
<td><a href="http://www.seasar.org/index.html"><img src="images/menu01_b_ja.gif" height="30" width="78" border="0" alt="" id="menu01" onmouseover="swap(1)" onmouseout="restore(1)"></a></td>
<td><a href="http://www.seasar.org/projects.html"><img src="images/menu02_b_ja.gif" height="30" width="101" border="0" alt="" id="menu02" onmouseover="swap(2)" onmouseout="restore(2)"></a></td>
<td><a href="http://www.seasar.org/products.html"><img src="images/menu03_b_ja.gif" height="30" width="110" border="0" alt="" id="menu03" onmouseover="swap(3)" onmouseout="restore(3)"></a></td>
<td><a href="http://www.seasar.org/resources.html"><img src="images/menu04_b_ja.gif" height="30" width="113" border="0" alt="" id="menu04" onmouseover="swap(4)" onmouseout="restore(4)"></a></td>
<td><img src="images/menu05_b_ja.gif" height="30" width="109" border="0" alt="" id="menu05" onmouseover="swap(5)" onmouseout="restore(5)"></td>
<td><img height="30" width="34" src="images/menu06.gif" alt=""></td></tr><tr>
<td colspan="6"><img height="19" width="545" src="images/spacer.gif" alt=""></td></tr></table>
<table  width="780" border="0" cellspacing="0" cellpadding="0" class="white">
<tr align="left" valign="top"><td width="14"><img height="14" width="14" src="images/spacer.gif" alt=""></td><td width="740" class="main">
<!-- don't edit end -->
<!-- document start -->

<h1>S2Unit.NETでテストを楽しく簡単に</h1>

<p>S2Container.NET(バージョン1.1以降)では、コンテナを使った開発のテストを楽しくおこなえるようにテスティングフレームワークが組み込まれています。
MbUnitを拡張しています。主な機能は以下のとおりです。</p>

<ul>
	<li>
		<a href="#autoS2">S2Containerの自動作成</a>
		<ul>
			<li>テストメソッド(TestXxx)ごとに自動的にS2Containerを作成します。</li>
			<li>S2Containerに対するRegister(),GetComponent(),Include()が用意されています。</li>
			<li>Include()するdiconファイルのPATHがテストクラスと同じ名前空間にある場合は、名前空間部分のパスは省略できます。</li>
		</ul>
	</li>
	<li>
		<a href="#fieldBinding">フィールドへの自動バインディング</a>
		<ul>
			<li>Testクラスにstatic,readonly,finalのいずれでもないフィールドがあり、
			その名前からアンダースコア(_)を(先頭もしくは後尾から)除いた名前のコンポーネントがコンテナに存在すれば自動的にセットされます。</li>
			<li>Testクラスのフィールドに、代入することのできるコンポーネント(参照型かDateTime)がコンテナに存在すれば、S2Containerから取り出して自動的にセットされます。</li>
			<li>テストメソッドが終わると、自動セットされた値は自動的にnull(VBの場合はNothing)がセットされます。</li>
		</ul>	
	</li>
	<li>
		<a href="#init">テストメソッド毎の初期化・終了処理</a>
		<ul>
			<li>テストメソッド(TestXxx)に対応するSetUpXxx(),TearDownXxx()を定義しておくと、
			SetUp()の後、TearDown()の前に自動的に呼び出されます。
			個別のテストメソッドごとの初期化・終了処理を簡単に行えるようになります。</li>
		</ul>
	</li>
	<li>
		<a href="#trans">トランザクションの自動制御</a>
		<ul>
			<li>テストメソッドのS2属性にTx列挙型(Seasar.Extension.Unit.Tx)のRollback(列挙子)を指定すると、
			テストメソッドの直前にトランザクションを開始し、テストメソッドの直後にトランザクションをロールバックするので、
			データベースに関するテストを行った場合のクリーンアップの処理が不要になります。</li>
		</ul>
	</li>
	<li>
		<a href="#DBTest">データベースに対するテスト</a>
		<ul>
			<li>Reload(DataSet)を使って、データの中身をプライマリーキーでリロードして新しいDataSetを取得できます。
			更新後の予想される結果をExcelで定義しておき、
			DataSet expected = ReadXls("予想される結果.xls");
			S2Assert.AreEqual(expected, Reload(expected);
			のようにして簡単に更新のテストができます。</li>
			<li>S2Assert.AreEqual()で予想されるDataSetの結果に対して、
			IDictionary、IDictionaryのIList、object、objectのIListと比較することができます。</li>
		</ul>
	</li>
</ul>

<h2><a name="setup">S2Unit.NETのインストール</a></h2>
<p><a href="setup.html#S2Unit">S2Unit.NETのインストールについてはこちらを参照して下さい</a></p>

<h2><a name="autoS2">S2Containerの自動作成</a></h2>
<p>
テストクラスはSeasar.Extension.Unit.S2TestCaseを継承して作成します。
クラスにはもちろんTestFixture属性(MbUnit.Framework.TestFixtureAttribute)も定義します。
テストメソッドにはTest属性(MbUnit.Framework.TestAttribute)と共に、
S2属性(Seasar.Extension.Unit.S2Attribute)を定義します。
このようなテストクラスを準備するとS2Containerが自動的に作成されます。
</p>
C#
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode">
[TestFixture]
<span class="kwrd">public</span> <span class="kwrd">class</span> HogeTest : S2TestCase
{
    [Test, S2]
    <span class="kwrd">public</span> <span class="kwrd">void</span> TestHogeHoge()
    {
        <span class="rem">// テストコードを書きます</span>
    }
}</pre>
VB.NET
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode vb">
&lt;TestFixture()&gt; _
<span class="kwrd">Public</span> <span class="kwrd">Class</span> HogeTest
   <span class="kwrd">Inherits</span> S2TestCase
   
    &lt;Test(), S2()&gt; _
    <span class="kwrd">Public</span> <span class="kwrd">sub</span> TestHogeHoge()
        <span class="rem">' テストコードを書きます</span>
    <span class="kwrd">End</span> <span class="kwrd">Sub</span>
    
<span class="kwrd">End</span> Class</pre>

<p>
S2TestClassにはS2Container.NETに対応するRegister(), GetComponent(), Include()
が用意されています。
</p>
C#
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode">
<span class="kwrd">public</span> <span class="kwrd">void</span> TestHogeHoge()
{
    <span class="rem">// diconファイルを取り込みます</span>
    Include(<span class="str">"Hoge.dicon"</span>);
    
    <span class="rem">// S2Containerにコンポーネントを登録します</span>
    Register(<span class="kwrd">typeof</span>(Hashtable));
    
    <span class="rem">// S2Containerからコンポーネントを取得します</span>
    Hashtable table = (Hashtable) GetComponent(<span class="kwrd">typeof</span>(Hashtable));
}</pre>
VB.NET
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode vb">
&lt;Test(), S2()&gt; _
<span class="kwrd">Public</span> <span class="kwrd">sub</span> TestHogeHoge()

    <span class="rem">' diconファイルを取り込みます</span>
    Include(<span class="str">"Hoge.dicon"</span>)
    
    <span class="rem">' S2Containerにコンポーネントを登録します</span>
    Register(<span class="kwrd">typeof</span>(Hashtable))
    
    <span class="rem">' S2Containerからコンポーネントを取得します</span>
    <span class="kwrd">Dim</span> table <span class="kwrd">As</span> Hashtable = <span class="kwrd">CType</span>(GetComponent(<span class="kwrd">GetType</span>(Hashtable)), Hashtable)
    
    <span class="rem">' 明示的にキャストしない場合は以下でも可</span>
    <span class="rem">' Dim table As Hashtable = GetComponent(GetType(Hashtable))</span>

<span class="kwrd">End</span> Sub</pre>

<p>
Include()するdiconファイルのPATHがテストクラスと同じ名前空間にある場合は、名前空間部分のパスは省略できます。
ファイルシステムでdiconファイルのPATHを指定する場合は、アセンブリと同じ位置の置くと相対パスとなり省略することができます。
（ただしビルドイベント等でアセンブリと同じフォルダにはき出す等の処理が必要です)
</p>
<p>
Foo.Fuga名前空間にTest.diconを用意している場合、
Foo.Fuga名前空間にあるクラスでは以下のようにdiconファイルのパスを省略することが出来ます。
</p>
C#
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode">
<span class="kwrd">namespace</span> Foo.Fuga
{
    [TestFixture]
    <span class="kwrd">public</span> <span class="kwrd">class</span> HogeTest : S2TestCase
    {
        [Test, S2]
        <span class="kwrd">public</span> <span class="kwrd">void</span> TestHogeHoge()
        {
            Include(<span class="str">"Test.dicon"</span>);
        }
    }
}</pre>
VB.NET
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode vb">
<span class="kwrd">Namespace</span> Foo.Fuga
   &lt;TestFixture()&gt; _
   <span class="kwrd">Public</span> <span class="kwrd">Class</span> HogeTest
      <span class="kwrd">Inherits</span> S2TestCase
      
      &lt;Test(), S2()&gt; _
      <span class="kwrd">Public</span> <span class="kwrd">Sub</span> TestHogeHoge()
         Include(<span class="str">"Test.dicon"</span>)
      <span class="kwrd">End</span> <span class="kwrd">Sub</span>
      
   <span class="kwrd">End</span> <span class="kwrd">Class</span>
<span class="kwrd">End</span> Namespace</pre>

<h2><a name="fieldBinding">フィールドへの自動バインディング</a></h2>
<p>
Testクラスにstatic,readonly,finalのいずれでもないフィールドがあり、 
その名前からアンダースコア(_)を(先頭もしくは後尾から)除いた名前のコンポーネントがコンテナに存在すれば自動的にセットされます。
</p>
Test.dicon
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode">
<span class="kwrd">&lt;</span><span class="html">components</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">component</span> <span class="attr">name</span><span class="kwrd">="abc"</span><span class="kwrd">&gt;</span>"hoge"<span class="kwrd">&lt;/</span><span class="html">component</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">components</span><span class="kwrd">&gt;</span></pre>
C#
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode">
[TestFixture]
<span class="kwrd">public</span> <span class="kwrd">class</span> HogeTest : S2TestCase
{
    <span class="kwrd">private</span> <span class="kwrd">string</span> _abc = <span class="kwrd">null</span>;

    [Test, S2]
    <span class="kwrd">public</span> <span class="kwrd">void</span> TestHogeHoge()
    {
        Include(<span class="str">"Test.dicon"</span>);
        Assert.AreEqual(<span class="str">"hoge"</span>, _abc);
    }
}</pre>
VB.NET
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode vb">
&lt;TestFixture()&gt; _
<span class="kwrd">Public</span> <span class="kwrd">Class</span> HogeTest
   <span class="kwrd">Inherits</span> S2TestCase
   
    <span class="kwrd">Private</span> _abc <span class="kwrd">As</span> <span class="kwrd">String</span> = <span class="kwrd">Nothing</span>
   
    &lt;Test(), S2()&gt; _
    <span class="kwrd">Public</span> <span class="kwrd">Sub</span> TestHogeHoge()
        Include(<span class="str">"Test.dicon"</span>)
        Assert.AreEqual(<span class="str">"hoge"</span>, _abc)
    <span class="kwrd">End</span> <span class="kwrd">Sub</span>

<span class="kwrd">End</span> Class</pre>

<p>
Testクラスのフィールドに、代入することのできるコンポーネント(参照型かDateTime)がコンテナに存在すれば、S2Containerから取り出して自動的にセットされます。
</p>
Test.dicon
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode">
<span class="kwrd">&lt;</span><span class="html">components</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">component</span> <span class="attr">class</span><span class="kwrd">="System.Collections.ArrayList"</span> <span class="kwrd">/&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">components</span><span class="kwrd">&gt;</span></pre>
C#
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode">
[TestFixture]
<span class="kwrd">public</span> <span class="kwrd">class</span> HogeTest : S2TestCase
{
    <span class="kwrd">private</span> IList _list = <span class="kwrd">null</span>;

    [Test, S2]
    <span class="kwrd">public</span> <span class="kwrd">void</span> TestHogeHoge()
    {
        Include(<span class="str">"Test.dicon"</span>);
        Assert.IsNotNull(_list);
    }
}</pre>
VB.NET
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode vb">
&lt;TestFixture()&gt;  _
<span class="kwrd">Public</span> <span class="kwrd">Class</span> HogeTest
    <span class="kwrd">Inherits</span> S2TestCase

    <span class="kwrd">Private</span> _list <span class="kwrd">As</span> IList = <span class="kwrd">Nothing</span>

    &lt;Test(), S2()&gt; _
    <span class="kwrd">Public</span> <span class="kwrd">Sub</span> TestHogeHoge()
        Include(<span class="str">"Test.dicon"</span>)
        Assert.IsNotNull(_list)
    <span class="kwrd">End</span> <span class="kwrd">Sub</span>

<span class="kwrd">End</span> Class</pre>

<p>
テストメソッドが終わると、自動セットされた値は自動的にnull(VBの場合はNothing)がセットされます。
</p>

<h2><a name="init">テストメソッド毎の初期化・終了処理</a></h2>
<p>
テストメソッド(TestXxx)に対応するSetUpXxx(),TearDownXxx()を定義しておくと、
SetUp()の後、TearDown()の前に自動的に呼び出されます。
個別のテストメソッドごとの初期化・終了処理を簡単に行えるようになります。
</p>
C#
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode">
[TestFixture]
<span class="kwrd">public</span> <span class="kwrd">class</span> HogeTest : S2TestCase
{
    <span class="kwrd">public</span> <span class="kwrd">void</span> SetUpHogeHoge() 
    {
        <span class="rem">// 初期化処理を行います </span>
    }

    [Test, S2]
    <span class="kwrd">public</span> <span class="kwrd">void</span> TestHogeHoge()
    {
        <span class="rem">// テストコードを書きます</span>
    }

    <span class="kwrd">public</span> <span class="kwrd">void</span> TearDownHogeHoge()
    {
        <span class="rem">// 終了処理を書きます</span>
    }
}</pre>
VB.NET
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode vb">
&lt;TestFixture()&gt; _
<span class="kwrd">Public</span> <span class="kwrd">Class</span> HogeTest
    <span class="kwrd">Inherits</span> S2TestCase
   
    <span class="kwrd">Public</span> <span class="kwrd">Sub</span> SetUpHogeHoge()
        <span class="rem">' 初期化処理を行います</span>
    <span class="kwrd">End</span> <span class="kwrd">Sub</span> 

    &lt;Test(), S2()&gt; _
    <span class="kwrd">Public</span> <span class="kwrd">Sub</span> TestHogeHoge()
        <span class="rem">' テストコードを書きます</span>
    <span class="kwrd">End</span> <span class="kwrd">Sub</span>

    <span class="kwrd">Public</span> <span class="kwrd">Sub</span> TearDownHogeHoge()
        <span class="rem">' 終了処理を書きます</span>
    <span class="kwrd">End</span> <span class="kwrd">Sub</span>

<span class="kwrd">End</span> Class</pre>

<h2><a name="trans">トランザクションの自動制御</a></h2>
<p>
テストメソッドのS2属性にTx列挙型(Seasar.Extension.Unit.Tx)のRollback(列挙子)を指定すると、
テストメソッドの直前にトランザクションを開始し、テストメソッドの直後にトランザクションをロールバックするので、
データベースに関するテストを行った場合のクリーンアップの処理が不要になります。
</p>
<p>
Rollbackの他に、Tx列挙型のCommit(列挙子)を指定すると、自動的にトランザクションをコミットします。
NotSupported(列挙子)を指定すると、トランザクションは開始しません。
S2属性にTx列挙型の列挙子を与えない場合は、デフォルトでNotSupported(列挙子)を指定したのと同じ動作をします。
</p>
<p>
またトランザクションを扱うためには、下記のようにTransactionContextとDataSourceを定義したdiconファイルを
読み込んでおく必要があります。
</p>
Ado.dicon
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode">
<span class="kwrd">&lt;</span><span class="html">components</span> <span class="attr">namespace</span><span class="kwrd">="Ado"</span><span class="kwrd">&gt;</span>

    <span class="kwrd">&lt;</span><span class="html">component</span> <span class="attr">name</span><span class="kwrd">="SqlClient"</span> <span class="attr">class</span><span class="kwrd">="Seasar.Extension.ADO.DataProvider"</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">property</span> <span class="attr">name</span><span class="kwrd">="ConnectionType"</span><span class="kwrd">&gt;</span>"System.Data.SqlClient.SqlConnection"<span class="kwrd">&lt;/</span><span class="html">property</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">property</span> <span class="attr">name</span><span class="kwrd">="CommandType"</span><span class="kwrd">&gt;</span>"System.Data.SqlClient.SqlCommand"<span class="kwrd">&lt;/</span><span class="html">property</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">property</span> <span class="attr">name</span><span class="kwrd">="ParameterType"</span><span class="kwrd">&gt;</span>"System.Data.SqlClient.SqlParameter"<span class="kwrd">&lt;/</span><span class="html">property</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">property</span> <span class="attr">name</span><span class="kwrd">="DataAdapterType"</span><span class="kwrd">&gt;</span>"System.Data.SqlClient.SqlDataAdapter"<span class="kwrd">&lt;/</span><span class="html">property</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">component</span><span class="kwrd">&gt;</span>
    
    <span class="kwrd">&lt;</span><span class="html">component</span> <span class="attr">name</span><span class="kwrd">="DataSource"</span> <span class="attr">class</span><span class="kwrd">="Seasar.Extension.Tx.Impl.TxDataSource"</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">property</span> <span class="attr">name</span><span class="kwrd">="DataProvider"</span><span class="kwrd">&gt;</span>SqlClient<span class="kwrd">&lt;/</span><span class="html">property</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">property</span> <span class="attr">name</span><span class="kwrd">="ConnectionString"</span><span class="kwrd">&gt;</span>
　　　　　　　　　　　　"Server=サーバ名;database=s2dotnetdemo;Integrated Security=SSPI"
　　　　　　　<span class="kwrd">&lt;/</span><span class="html">property</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">component</span><span class="kwrd">&gt;</span>

    <span class="kwrd">&lt;</span><span class="html">component</span> <span class="attr">class</span><span class="kwrd">="Seasar.Extension.Tx.Impl.TransactionContext"</span> <span class="kwrd">/&gt;</span>
    
<span class="kwrd">&lt;/</span><span class="html">components</span><span class="kwrd">&gt;</span></pre>

C#
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode">
[TestFixture]
<span class="kwrd">public</span> <span class="kwrd">class</span> HogeTest : S2TestCase
{
    <span class="kwrd">public</span> <span class="kwrd">void</span> SetUpHogeHoge() 
    {
        Include(<span class="str">"Ado.dicon"</span>);
    }

    [Test, S2(Tx.Rollback)]
    <span class="kwrd">public</span> <span class="kwrd">void</span> TestHogeHoge()
    {
        <span class="rem">// メソッド終了後に自動的にロールバックされます</span>
    }
}</pre>

VB.NET
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode">
&lt;TestFixture&gt; _ 
<span class="kwrd">Public</span> <span class="kwrd">Class</span> HogeTest
     <span class="kwrd">Inherits</span> S2TestCase

    <span class="kwrd">Public</span>  <span class="kwrd">Sub</span> SetUpHogeHoge()
        Include(<span class="str">"Ado.dicon"</span>)
    <span class="kwrd">End</span> <span class="kwrd">Sub</span>
 
    &lt;Test, S2(Tx.Rollback)&gt; _ 
    <span class="kwrd">Public</span>  <span class="kwrd">Sub</span> TestHogeHoge()
        <span class="rem">' メソッド終了後に自動的にロールバックされます</span>
    <span class="kwrd">End</span> <span class="kwrd">Sub</span>

<span class="kwrd">End</span> Class</pre>

<h2><a name="trans">データベースに対するテスト</a></h2>
<p>
S2では、データベースに対するテストも簡単に行えるような仕組みを用意しております。
それでは、さっそく例を見てみましょう。
SQL文を発行するためのフレームワークとしてS2ADOを使います。
</p>

<h3><a name="SelectTest">Select文に対するテスト</a></h3>
<p>
今回は、従業員を従業員番号で検索するDAOをサンプルにします。
シナリオとして従業員番号で検索をかけると、従業員番号9900の従業員テーブルと部署番号99の部署テーブルをジョインして返す想定とします。
このケースをテストするためには、検索のための従業員テーブルと部署テーブルのデータを検索した結果を検証するためのデータが必要です。
データはExcelで用意します。シート名がテーブル名で、シートの第1行にカラム名を2行目以降にデータを書き込みます。
1から手でデータを作成してもいいのですが、ここでは既存のテーブルのデータを利用してテストデータを作成します。
<a href="setup.html">セットアップ</a>を参照してデータベースを作成しておきます。
Seasar.Examplesにデータベースの内容をExcelに書き出すDb2ExcelClientが用意されているのでそれを使います。
</p>
Seasar/Examples/Reference/S2Unit/Db2ExcelClient.dicon
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode">
&lt;components&gt;
  &lt;include path=<span class="str">"Seasar.Examples/Ado.dicon"</span> /&gt;
  &lt;component name=<span class="str">"Db2ExcelClient"</span> <span class="kwrd">class</span>=<span class="str">"Seasar.Examples.Reference.S2Unit.Db2ExcelClient"</span>/&gt;
  &lt;component <span class="kwrd">class</span>=<span class="str">"Seasar.Extension.DataSets.Impl.SqlReader"</span>&gt;
    &lt;initMethod&gt;self.AddTable(<span class="str">"emp"</span>, <span class="str">"empno = 7788"</span>)&lt;/initMethod&gt;
    &lt;initMethod&gt;self.AddTable(<span class="str">"dept"</span>, <span class="str">"deptno = 20"</span>)&lt;/initMethod&gt;
  &lt;/component&gt;
  &lt;component <span class="kwrd">class</span>=<span class="str">"Seasar.Extension.DataSets.Impl.XlsWriter"</span> instance=<span class="str">"prototype"</span>&gt;
    &lt;arg&gt;<span class="str">"Seasar.Examples/Reference/S2Unit/GetEmployeePrepare.xls"</span>&lt;/arg&gt;
  &lt;/component&gt;
&lt;/components&gt;
</pre>
<p>
データベースの内容をDataSetに読み込んでくれるのがSqlReaderです。AddTableの最初の引数はテーブル名(シート名)です。
2番目の引数は条件になります。
</p>
<p>
DataSetをExcelに書き出してくれるのがXlsWriterです。コンストラクタでファイルのパスを指定します。
パスは出力フォルダが基点になります。
</p>
Seasar/Examples/Reference/S2Unit/Db2ExcelClient
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode">
<span class="kwrd">using</span> System;
<span class="kwrd">using</span> Seasar.Extension.DataSets.Impl;
<span class="kwrd">using</span> Seasar.Framework.Container;
<span class="kwrd">using</span> Seasar.Framework.Container.Factory;

<span class="kwrd">namespace</span> Seasar.Examples.Reference.S2Unit
{
    <span class="kwrd">public</span> <span class="kwrd">class</span> Db2ExcelClient
    {
        <span class="kwrd">private</span> <span class="kwrd">static</span> <span class="kwrd">readonly</span> <span class="kwrd">string</span> PATH = <span class="str">"Seasar.Examples/Reference/S2Unit/Db2ExcelClient.dicon"</span>;

        <span class="kwrd">public</span> Db2ExcelClient() { }

        <span class="kwrd">public</span> <span class="kwrd">void</span> Main()
        {
            IS2Container container = S2ContainerFactory.Create(PATH);
            container.Init();
            <span class="kwrd">try</span>
            {
                SqlReader reader = (SqlReader) container.GetComponent(<span class="kwrd">typeof</span>(SqlReader));
                XlsWriter writer = (XlsWriter) container.GetComponent(<span class="kwrd">typeof</span>(XlsWriter));
                writer.Write(reader.Read());
                Console.Out.WriteLine(<span class="str">"output Excel File : {0}"</span>, writer.FullPath);
            }
            <span class="kwrd">catch</span> (ApplicationException e)
            {
                Console.Out.WriteLine(e.Message);
            }
        }
    }
}
</pre>
<p>
IS2ContainerからSqlReaderを取り出しRead()、XlsWriterを取り出しWrite()するだけで、
データベースの内容をExcelに書き出すことができます。
Seasar.Examplesを起動し、ツリーアイテムからS2Containerリファレンス-Select文に対するテスト(1)、を選択すると
Visual Studioの出力パス+指定パス(例：bin\Debug\Seasar.Examples\Reference\S2Unit)に
GetEmployeePrepare.xlsが作成されていることが確認できると思います。
GetEmployeePrepare.xlsをダブルクリックするとExcelが起動します。
empシートのEMPNOを9900、ENAMEをSCOTT2、DEPTNOを99に変更します。
続いてdeptシートのDEPTNOを99、DNAMEをRESEARCH2に変更します。これで検索用の元データは用意できます。Excelで保存を選び、終了します。
</p>
<p>
次に結果を検証するためのデータを用意します。
Seasar.Examplesに検証データを書き出すDb2ExcelClient2が用意されているのでそれを使います。
</p>
Seasar/Examples/Reference/S2Unit/Db2ExcelClient2.dicon
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode">
&lt;components&gt;
  &lt;include path=<span class="str">"Seasar.Examples/Ado.dicon"</span> /&gt;
  &lt;component name=<span class="str">"EmployeeDaoTest"</span> <span class="kwrd">class</span>=<span class="str">"Seasar.Examples.Reference.S2Unit.EmployeeDaoTest"</span>/&gt;
  &lt;component <span class="kwrd">class</span>=<span class="str">"Seasar.Examples.Reference.S2Unit.EmployeeDao"</span>&gt;
    &lt;property name=<span class="str">"GetEmployeeHandler"</span>&gt;
      &lt;component <span class="kwrd">class</span>=<span class="str">"Seasar.Extension.ADO.Impl.BasicSelectHandler"</span>&gt;
        &lt;property name=<span class="str">"Sql"</span>&gt;<span class="str">
"SELECT e.empno, e.ename, e.deptno, d.dname
FROM emp e, dept d WHERE e.empno = @empno AND e.deptno = d.deptno"</span>&lt;/property&gt;
      &lt;/component&gt;
    &lt;/property&gt;
  &lt;/component&gt;
&lt;/components&gt;
</pre>
<p>
Seasar.Examplesを起動し、ツリーアイテムからS2Containerリファレンス-Select文に対するテスト(2)、を選択すると
Visual Studioの出力パス+指定パス(例：bin\Debug\Seasar.Examples\Reference\S2Unit)にGetEmployeeResult.xlsを作成します。
</p>
<p>
先ほどと同様な手順でGetEmployeeResult.xlsのempシートのEMPNOを9900、ENAMEをSCOTT2、DEPTNOを99、DNAMEをRESEARCH2に書き換えて保存します。
これで、テスト用のデータがそろいました。いよいよテストに取り掛かります。
</p>
Seasar/Examples/Reference/S2Unit/EmployeeDao.dicon
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode">
&lt;components&gt;
  &lt;include path=<span class="str">"Seasar.Examples/Ado.dicon"</span> /&gt;
  &lt;component name=<span class="str">"EmployeeDaoTest"</span> <span class="kwrd">class</span>=<span class="str">"Seasar.Examples.Reference.S2Unit.EmployeeDaoTest"</span>/&gt;
  &lt;component <span class="kwrd">class</span>=<span class="str">"Seasar.Examples.Reference.S2Unit.EmployeeDao"</span>&gt;
    &lt;property name=<span class="str">"GetEmployeeHandler"</span>&gt;
      &lt;component <span class="kwrd">class</span>=<span class="str">"Seasar.Extension.ADO.Impl.BasicSelectHandler"</span>&gt;
        &lt;property name=<span class="str">"Sql"</span>&gt;<span class="str">
"SELECT e.empno, e.ename, e.deptno, d.dname 
FROM emp e, dept d WHERE e.empno = @empno AND e.deptno = d.deptno"</span>&lt;/property&gt;
      &lt;/component&gt;
    &lt;/property&gt;
  &lt;/component&gt;
&lt;/components&gt;
</pre>

Seasar/Examples/Reference/S2Unit/EmployeeDaoTest.cs
<!-- code formatted by http://manoli.net/csharpformat/ -->
<pre class="csharpcode">
<span class="kwrd">using</span> System.Data;
<span class="kwrd">using</span> MbUnit.Core.Cons;
<span class="kwrd">using</span> MbUnit.Framework;
<span class="kwrd">using</span> Seasar.Extension.DataSets.Impl;
<span class="kwrd">using</span> Seasar.Extension.Unit;

<span class="kwrd">namespace</span> Seasar.Examples.Reference.S2Unit
{
    [TestFixture]
    <span class="kwrd">public</span> <span class="kwrd">class</span> EmployeeDaoTest : S2TestCase
    {
        <span class="kwrd">private</span> IEmployeeDao dao_ = <span class="kwrd">null</span>;

        <span class="kwrd">public</span> <span class="kwrd">void</span> SetUpGetEmployee()
        {
            Include(<span class="str">"Seasar.Examples/Reference/S2Unit/EmployeeDao.dicon"</span>);
        }

        [Test, S2(Tx.Rollback)]
        <span class="kwrd">public</span> <span class="kwrd">void</span> GetEmployee()
        {
            ReadXlsWriteDb(<span class="str">"Seasar.Examples/Reference/S2Unit/GetEmployeePrepare.xls"</span>);
            Employee emp = dao_.GetEmployee(9900);
            DataSet expected = ReadXls(<span class="str">"Seasar.Examples/Reference/S2Unit/GetEmployeeExpected.xls"</span>);
            S2Assert.AreEqual(expected, emp, <span class="str">"1"</span>);
        }

        <span class="kwrd">public</span> <span class="kwrd">void</span> Main()
        {
            <span class="kwrd">using</span> (MainClass mc = <span class="kwrd">new</span> MainClass())
            {
                mc.Main(<span class="kwrd">new</span> <span class="kwrd">string</span>[] { <span class="str">"Seasar.Examples.exe"</span> });
            }
        }
    }
}
</pre>
<p>
Seasar.Examplesを起動し、ツリーアイテムからS2Containerリファレンス-Select文に対するテスト(3)、を選択するとテストが実行されます。
ここでは説明のためにコンソールから<a href="http://www.mertner.com/confluence/display/MbUnit/Home" target="_blank">MbUnit</a>を実行していますが、
MbUnit.GUI.exeや<a href="http://www.testdriven.net/" target="_blank">TestDriven.NET</a>を使用したほうがテストしやすいでしょう。
</p>
<p>
SetUpGetEmployee()がapp.diconの役割を担います。S2Assert.AreEqual()でDataSetとIDictionary、IDictionaryのIList、object、objectのIList
と比較できるのですっきりとしたテストコードになります。
</p>
<p>
ReadXlsWriteDb()、ReadXlsAllReplaceDb()で、テストのために用意したデータをデータベースに格納します。
Excelのファイルがテストクラスと同じ名前空間にある場合は、名前空間部分のパスは省略できます。
(ただしビルドイベント等でアセンブリと同じフォルダにはき出す等の処理が必要です)
ReadXlsWriteDb()、ReadXlsAllReplaceDb()はテスト後にロールバックしてデータが元に戻るようにテストメソッドの最初に実行してください。
これらのメソッドは、シート名の昇順にデータを挿入します。外部キー制約に引っかかるためデータの挿入順序を制御する場合、
シート名の先頭に"# {順序}"を付けます。例えば、empテーブルを3番目に挿入する場合、シート名は"#3 emp"になります。
</p>
<p>
Daoを呼び出して取得したデータとReadXls()で読み込んだ結果検証用のExcelデータをS2Assert.AreEqual()に渡すと
Daoを呼び出して取得したデータがDataSetに変換され、結果検証用のExcelデータと比較します。
</p>

<!-- document end -->
<!-- don't edit start -->
</td>
<td width="14"><img height="14" width="14" src="images/spacer.gif" alt=""></td>
</tr><tr>
<td width="14"><img height="30" width="14" src="images/spacer.gif" alt=""></td>
<td width="766"><img height="30" width="592" src="images/spacer.gif" alt=""></td>
</tr><tr>
<td width="14"><img height="14" width="14" src="images/spacer.gif" alt=""></td>
<td width="766" class="copyright">Copyright&copy; 2004-2006, The Seasar Foundation and the others. All rights reserved.</td>
</tr></table>
<td class="backright" align="left" valign="top">&nbsp;</td></tr><tr>
<td class="backunder" align="left"  valign="top" width="780" height="16">&nbsp;</td>
<td class="backcorner" align="left" valign="top" height="16">&nbsp;</td>
</tr></table>
</body>
<!-- don't edit end -->
</html>
